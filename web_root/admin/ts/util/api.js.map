{"version":3,"sources":["/ts/util/api.ts"],"names":[],"mappings":"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","file":"api.js","sourcesContent":["import cfg from '../app.cfg';\r\nimport {store} from \"./store\";\r\nimport {format} from './utils';\r\n\r\n\r\n\r\ninterface AjaxMessage {\r\n\tdata ?: any ,\r\n\terror?: string\r\n}\r\n\r\ninterface ApiCall {\r\n\t(param: any, callback: Function):void ;\r\n\t(callback: Function) :void ;\r\n\tset(key: string, value: any): this ;\r\n\tget(key: string): any\r\n}\r\n\r\ninterface IApiConfig {\r\n\t(apiSets: Map): void\r\n}\r\n\r\n//noinspection TypeScriptUnresolvedVariable\r\n//cfg.apiServer = window.apiServer ;\r\n\r\nif (!cfg.apiServer) {\r\n\tcfg.onUnauthorizedError();\r\n}\r\n\r\nlet onServerError = cfg.onServerError || function (msg) {\r\n\t\talert(\"err: \" + msg);\r\n\t};\r\n\r\nlet loading = {\r\n\tdom: $('#opgAjaxLoading'),\r\n\thandlers: 0,\r\n\ttimer: 0,\r\n\tshow: function () {\r\n\t\tloading.dom.stop(true, true).fadeIn();\r\n\t},\r\n\thide: function () {\r\n\t\tif (!loading.handlers)\r\n\t\t\tloading.dom.stop(true, true).fadeOut();\r\n\t}\r\n};\r\n\r\n\r\n\r\nclass ServerFn {\r\n\r\n\tname: string;\r\n\tmethod: string;\r\n\trestful: boolean;\r\n\turl: string;\r\n\r\n\tunlimited: boolean;\r\n\taccessible: boolean;\r\n\ttimeOut: number ; //in milliseconds\r\n\r\n\tonError?: Function;\r\n\r\n\r\n\tconstructor(url: string, name: string, method = 'GET', restful = true) {\r\n\r\n\t\tthis.name = name;\r\n\t\tthis.method = method;\r\n\t\tthis.restful = restful;\r\n\t\tthis.timeOut = cfg.ajaxTimeOut ;\r\n\r\n\t\tif (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) this.url = url;\r\n\t\telse this.url = cfg.apiServer + url.replace(/^\\//, '');\r\n\r\n\r\n\t\tthis.unlimited = false;\r\n\t\tthis.accessible = true;\r\n\r\n\t}\r\n\r\n\thandleError(error, callback) {\r\n\t\tif (typeof this.onError === 'function')\r\n\t\t\treturn this.onError.call(this, error, callback);\r\n\t\telse\r\n\t\t\treturn onServerError.call(this, error, callback);\r\n\t}\r\n\r\n\tinvoke(data, callback): JQueryXHR {\r\n\t\tlet that = this;\r\n\r\n\t\tif (this.accessible || this.unlimited) {\r\n\t\t\tthis.accessible = false;\r\n\t\t\t//return $[this.method].apply(this, makeParam.call(this, data, callback, type || 'json'));\r\n\t\t\tif ($.isFunction(data)) {\r\n\t\t\t\tcallback = data;\r\n\t\t\t\tdata = null;\r\n\t\t\t}\r\n\r\n\t\t\tlet url = this.url , method = this.method;\r\n\t\t\tlet contentType: string|boolean = 'application/json';\r\n\t\t\tlet processData: boolean = true;\r\n\r\n\t\t\tif(method === 'UPLOAD'){\r\n\t\t\t\tcontentType = false;\r\n\t\t\t\tprocessData = false ;\r\n\t\t\t\tmethod = 'POST' ;\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tif (data) {\r\n\t\t\t\t\tif (!this.restful && this.method != 'GET') {\r\n\t\t\t\t\t\tdata = JSON.stringify(data);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (this.restful) {\r\n\t\t\t\t\t\turl = format.json(url, data);\r\n\t\t\t\t\t\tdata = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\treturn $.ajax({\r\n\t\t\t\t//headers: xToken,\r\n\t\t\t\tcontentType: contentType,\r\n\t\t\t\tprocessData : processData ,\r\n\t\t\t\tdataType: 'json' ,\r\n\t\t\t\turl: url,\r\n\t\t\t\tdata: data,\r\n\t\t\t\tmethod: method,\r\n\t\t\t\tcache: false,\r\n\t\t\t\ttimeout: that.timeOut,\r\n\t\t\t\tbeforeSend: function (jqXHR: JQueryXHR, settings: JQueryAjaxSettings) {\r\n\t\t\t\t\tloading.handlers++;\r\n\r\n\t\t\t\t\tif (loading.timer) clearTimeout(loading.timer);\r\n\t\t\t\t\tloading.timer = 0;\r\n\t\t\t\t\tloading.show();\r\n\r\n\t\t\t\t},\r\n\t\t\t\tcomplete: function () {\r\n\t\t\t\t\tloading.handlers--;\r\n\t\t\t\t\tloading.timer = setTimeout(loading.hide, 100);\r\n\r\n\t\t\t\t\tthat.accessible = true;\r\n\t\t\t\t\tthat = null;\r\n\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t},\r\n\t\t\t\terror: function (jqXHR: JQueryXHR, textStatus: string, errorThrown: string) {\r\n\t\t\t\t\tif (jqXHR.responseJSON && jqXHR.responseJSON.meta && jqXHR.responseJSON.meta.message) {\r\n\t\t\t\t\t\tthat.handleError.call(that, jqXHR.responseJSON.meta.message, callback);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tlet code = jqXHR.status;\r\n\r\n\t\t\t\t\t\tif (errorThrown === 'timeout')\r\n\t\t\t\t\t\t\terrorThrown = '连接超时';\r\n\t\t\t\t\t\telse if (!errorThrown)\r\n\t\t\t\t\t\t\terrorThrown = '无法连接服务器';\r\n\t\t\t\t\t\telse if (errorThrown === 'Not Found')\r\n\t\t\t\t\t\t\terrorThrown = '无此接口';\r\n\r\n\t\t\t\t\t\tthat.handleError.call(that, `api.${that.name} error ${code} (${errorThrown})`);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json: AjaxMessage, textStatus: string, jqXHR: JQueryXHR) {\r\n\r\n\t\t\t\t\tif (json.error) {\r\n\t\t\t\t\t\tthat.handleError.call(that, json.error , callback);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (callback && typeof callback === 'function')\r\n\t\t\t\t\t\t\tcallback(json , textStatus, jqXHR);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthrow new Error('Server function [' + this.name + '] unusable now.');\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\nlet api: IApiConfig = function (apiSet: Map<string>) {\r\n\r\n\tfor (let key: string in apiSet) {\r\n\t\tlet uArr = key.split('!');\r\n\t\tlet pName = uArr[0];\r\n\t\tlet pMethod = uArr[1] ? uArr[1].toString().toUpperCase() : 'GET';\r\n\t\tlet restful = (!(uArr[2] === undefined)) || (apiSet[key].indexOf('${') > -1);\r\n\r\n\t\tif (!api[pName]) {\r\n\t\t\tapi[pName] = (function (srvFn: ServerFn) {\r\n\r\n\t\t\t\tlet fn: ApiCall = <ApiCall> function (data, callback) {\r\n\t\t\t\t\treturn srvFn.invoke.call(srvFn, data, callback);\r\n\t\t\t\t};\r\n\r\n\t\t\t\tfn.set = (k, v) => {\r\n\t\t\t\t\tsrvFn[k] = v;\r\n\t\t\t\t\treturn fn;\r\n\t\t\t\t};\r\n\r\n\t\t\t\tfn.get = (k: string) => srvFn[k];\r\n\r\n\t\t\t\tfn.toString = () => srvFn.url;\r\n\r\n\t\t\t\t/*fn.post = (data , cb)=>{\r\n\t\t\t\t fn.set('method' , 'POST') ;\r\n\t\t\t\t return fn(data , cb);\r\n\t\t\t\t };*/\r\n\r\n\r\n\t\t\t\treturn fn;\r\n\t\t\t})(new ServerFn(apiSet[key], pName, pMethod, restful));\r\n\t\t}\r\n\t\telse {\r\n\t\t\t//throw new Error('api [' + pName + '] duplicate definition');\r\n\t\t\tconsole.error(`api [${pName}] duplicate definition`);\r\n\t\t}\r\n\t}\r\n\r\n\treturn api;\r\n};\r\n\r\n\r\nexport {api, AjaxMessage} ;"]}